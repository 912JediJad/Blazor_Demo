@page "/hangman"
@rendermode InteractiveServer

<h1>Hangman (2-Player)</h1>

@if (!gameStarted)
{
    <h3>Step 1: Player 1 enters a word</h3>
    <p>Have Player 2 look away ðŸ‘€</p>

    <input @bind="secretWordInput" @bind:event="oninput" placeholder="Enter secret word" />
    <button @onclick="StartGame">Start Game</button>

    @if (!string.IsNullOrEmpty(message))
    {
        <p style="color:red">@message</p>
    }
}
else
{
    <h3>Step 2: Player 2 guesses the word</h3>

    <p><strong>Word:</strong> <span style="font-size: 24px; font-weight: bold;">@DisplayMaskedWord(maskedWord)</span></p>
    <p><strong>Guessed letters:</strong> @string.Join(", ", guessedLetters)</p>
    <p><strong>Attempts left:</strong> @attemptsLeft</p>

    @if (!gameOver)
    {
        <input @bind="guessInput" @bind:event="oninput" maxlength="1" placeholder="Enter a letter" />
        <button @onclick="MakeGuess">Guess</button>
    }

    @if (!string.IsNullOrEmpty(message))
    {
        <p><strong>@message</strong></p>
    }

    <button @onclick="ResetGame">New Game</button>
}

@code {
    // --- State ---

    private string secretWord = "";       // word that Player 1 chose
    private string maskedWord = "";       // what Player 2 sees (e.g. "_ _ _")
    private string secretWordInput = "";  // temp input for Player 1
    private string guessInput = "";       // temp input for Player 2

    private List<char> guessedLetters = new(); // all guessed letters
    private int attemptsLeft = 6;
    private bool gameStarted = false;
    private bool gameOver = false;
    private string message = "";

    // --- StartGame: run when Player 1 clicks "Start Game" ---

    private void StartGame()
    {
        message = "";

        if (string.IsNullOrWhiteSpace(secretWordInput))
        {
            message = "Please enter a word.";
            StateHasChanged();
            return;
        }

        // Normalize to uppercase for easier comparison
        secretWord = secretWordInput.Trim().ToUpperInvariant();

        // Build the masked word: letters -> '_', other chars stay
        char[] chars = new char[secretWord.Length];
        for (int i = 0; i < secretWord.Length; i++)
        {
            if (char.IsLetter(secretWord[i]))
            {
                chars[i] = '_';
            }
            else
            {
                chars[i] = secretWord[i];
            }
        }

        maskedWord = new string(chars);

        guessedLetters.Clear();
        attemptsLeft = 6;
        gameStarted = true;
        gameOver = false;

        // Clear the input so Player 2 can't see it
        secretWordInput = "";
        StateHasChanged();
    }

    // --- MakeGuess: run when Player 2 clicks "Guess" ---

    private void MakeGuess()
    {
        if (gameOver)
            return;

        message = "";

        if (string.IsNullOrWhiteSpace(guessInput))
        {
            message = "Enter a letter first.";
            StateHasChanged();
            return;
        }

        if (guessInput.Length > 1)
        {
            message = "Please enter only ONE letter at a time.";
            guessInput = "";
            StateHasChanged();
            return;
        }

        char g = char.ToUpperInvariant(guessInput[0]);

        if (!char.IsLetter(g))
        {
            message = "Please guess a letter (A-Z).";
            guessInput = "";
            StateHasChanged();
            return;
        }

        if (guessedLetters.Contains(g))
        {
            message = $"You already guessed '{g}'.";
            guessInput = "";
            StateHasChanged();
            return;
        }

        guessedLetters.Add(g);

        if (secretWord.Contains(g))
        {
            // Reveal the letter(s) in maskedWord
            char[] chars = maskedWord.ToCharArray();
            for (int i = 0; i < secretWord.Length; i++)
            {
                if (secretWord[i] == g)
                {
                    chars[i] = g;
                }
            }
            maskedWord = new string(chars);

            if (!maskedWord.Contains('_'))
            {
                message = $"ðŸŽ‰ You guessed it! The word was \"{secretWord}\".";
                gameOver = true;
            }
            else
            {
                message = $"Nice! '{g}' is in the word.";
            }
        }
        else
        {
            attemptsLeft--;

            if (attemptsLeft <= 0)
            {
                message = $"ðŸ’€ Game over! The word was \"{secretWord}\".";
                gameOver = true;
            }
            else
            {
                message = $"Nope, '{g}' is not in the word.";
            }
        }

        guessInput = "";
        StateHasChanged();
    }

    // --- ResetGame: run when "New Game" is clicked ---

    private void ResetGame()
    {
        secretWord = "";
        maskedWord = "";
        secretWordInput = "";
        guessInput = "";
        guessedLetters.Clear();
        attemptsLeft = 6;
        gameStarted = false;
        gameOver = false;
        message = "";
    }

    // --- DisplayMaskedWord: format the word with spacing between words ---

    private MarkupString DisplayMaskedWord(string masked)
    {
        // Split by spaces in the original secret word to identify word boundaries
        string[] words = secretWord.Split(' ');
        string[] maskedWords = masked.Split(' ');
        
        string result = "";
        for (int i = 0; i < maskedWords.Length; i++)
        {
            if (i > 0)
                result += "&nbsp;&nbsp;&nbsp;&nbsp;"; // Extra spacing between words
            
            result += string.Join("&nbsp;", maskedWords[i].ToCharArray());
        }
        
        return (MarkupString)result;
    }
}
